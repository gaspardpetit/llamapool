<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
	<Package Name="infx" Manufacturer="infx" Version="0.0.1"
			 UpgradeCode="2b2ad0a1-9a9a-4f85-becb-f93347172913">
		<MediaTemplate />
		<!-- Optional but recommended -->
		<!-- <MajorUpgrade DowngradeErrorMessage="A newer version of infx is already installed."/> -->

		<!-- 64-bit program files root -->
		<StandardDirectory Id="ProgramFiles64Folder">
			<Directory Id="INSTALLFOLDER" Name="infx">
				<Component Id="WorkerExe" Guid="2f3e5d88-1b9e-4e76-8cfb-2a4e3cd85406">
					<File Id="InfxWorkerExe" Source="$(var.WorkerExe)" KeyPath="yes" />
				</Component>

				<Component Id="ServiceExe" Guid="ad770f31-08dd-4ec6-9c07-4b993b0c7a40">
					<File Id="WindowsServiceExe" Source="$(var.ServiceExe)" KeyPath="yes" />
					<ServiceInstall Id="InfxService"
									Name="infx"
									DisplayName="infx"
									Start="auto"
									ErrorControl="normal"
									Type="ownProcess" />
					<ServiceControl Id="StartService"
									Name="infx"
									Start="install"
									Stop="both"
									Remove="uninstall"
									Wait="yes" />
				</Component>

				<Directory Id="TrayDir" Name="Tray">
					<Component Id="TrayApp" Guid="a7aa5b71-3e64-4f0d-bc67-a70d59cc8bb2">
						<File Id="TrayAppExe" Source="$(var.TrayExe)" KeyPath="yes" />
					</Component>
				</Directory>
			</Directory>
		</StandardDirectory>

		<!-- Per-user Start Menu shortcut in its own HKCU-keyed component (fixes ICE43/57/64) -->
		<StandardDirectory Id="ProgramMenuFolder">
			<Directory Id="ProgramMenuDir" Name="infx">
				<Component Id="TrayShortcutCmp" Guid="c1b2b3c4-d5e6-47f8-9a0b-112233445566">
					<!-- HKCU registry value as KeyPath for non-advertised shortcut -->
					<RegistryValue Root="HKCU"
								   Key="Software\infx\Installer"
								   Name="TrayShortcut"
								   Type="string"
								   Value="1"
								   KeyPath="yes" />
					<Shortcut Id="TrayShortcut"
							  Name="infx Tray"
							  Directory="ProgramMenuDir"
							  Target="[INSTALLFOLDER]Tray\TrayApp.exe"
							  WorkingDirectory="TrayDir" />
					<!-- Ensure Start Menu folder is removed on uninstall (ICE64) -->
					<RemoveFolder Id="RemoveProgramMenuDir" Directory="ProgramMenuDir" On="uninstall" />
				</Component>
			</Directory>
		</StandardDirectory>

		<!-- Per-machine data under ProgramData -->
		<StandardDirectory Id="CommonAppDataFolder">
			<Directory Id="ProgramDataInfx" Name="infx">
				<Component Id="ProgramData" Guid="c025ef5f-08da-4d66-a1fd-a755dc8e7e7b">
					<CreateFolder />
				</Component>
				<Directory Id="LogsDir" Name="Logs">
					<Component Id="LogsFolder" Guid="fb6cb1a9-1c2e-44c0-9ce2-2f7d9c5f2bf7">
						<CreateFolder />
					</Component>
				</Directory>
				<Component Id="ConfigFile" Guid="6ab4c1c6-b0a4-4c93-8c56-2c5b4c0d2c77">
					<File Id="WorkerYaml" Source="$(var.DefaultConfig)" Name="worker.yaml" KeyPath="yes" />
				</Component>
			</Directory>
		</StandardDirectory>

		<!-- Feature must also be inside <Package> -->
		<Feature Id="ProductFeature" Title="infx" Level="1">
			<ComponentRef Id="WorkerExe" />
			<ComponentRef Id="ServiceExe" />
			<ComponentRef Id="TrayApp" />
			<ComponentRef Id="TrayShortcutCmp" />
			<ComponentRef Id="ProgramData" />
			<ComponentRef Id="LogsFolder" />
			<ComponentRef Id="ConfigFile" />
		</Feature>
	</Package>
</Wix>
